# 详细规则

## 原子性原则

每篇笔记必须严格遵循"一事一议"，禁止在一篇笔记中讨论多个技术概念或混合不同主题。

## 字数限制

每篇笔记正文（不含标题）必须控制在250-300字之间，精确满足"不超过300字"的硬性要求。

## 结构规范

必须包含两级结构：
1. 标题（简洁技术术语）
2. 正文（技术说明）

禁止三级标题或列表嵌套。

## 纯净文本

严禁使用：
- 表情符号
- ASCII艺术
- 富文本标记（包括Markdown语法如**粗体**、*斜体*、`代码`）
- HTML标签
- 颜色标记

## 技术语调

- 使用专业、客观的技术文档语调
- 避免口语化表达
- 禁止使用"我们"、"你"等人称代词
- 改用无人称或被动语态

## 文件隔离原则

每个要点必须生成独立的.txt文件，严禁将多篇笔记合并写入单个文件。

## 现有笔记检查机制

在生成新笔记前，必须执行以下检查流程：

### 检查步骤

1. **扫描目录**: 列出output_directory中所有.txt文件
2. **提取关键词**: 从新笔记标题中提取核心技术关键词（技术栈名称、核心概念、关键术语）
3. **相似度计算**: 与现有笔记标题进行关键词匹配
   - 完全匹配关键词数 / 总关键词数 > 70% 视为高度相似
   - 技术栈名称 + 核心概念同时匹配视为相关笔记
4. **内容比对**: 若标题相似度较高，进一步比对正文前50字的技术定义部分

### 用户交互流程

发现相似笔记时，向用户展示：

```
发现相似笔记：
- 现有笔记: [文件路径]
- 标题: [现有标题]
- 相似度: [百分比]
- 内容摘要: [前100字]

新笔记标题: [新标题]

请选择操作：
[1] 合并到现有笔记（在现有文件末尾添加新内容，用空行分隔）
[2] 另起新文件名（请提供新的文件名，禁止自动添加版本号）
[3] 取消生成此笔记
[4] 查看现有笔记完整内容

注意：系统不会自动添加_v2、_v3等版本号，必须由您决定最终文件名
```

### 合并规则

若用户选择合并：
- 在现有文件末尾添加两个换行符作为分隔
- 追加新笔记的标题和正文
- 保持原子性：即使合并，每个概念仍独立成段
- 合并后总字数不受300字限制，但每个概念段仍保持250-300字

### 跳过条件

以下情况自动跳过检查：
- 输出目录不存在或为空
- 现有笔记创建时间超过90天（视为归档内容）
- 用户明确指定`--force`或`--no-check`参数

## 文件名规则（SEO优化）

格式: `{seo_title}.txt`

### 命名原则

1. **语言适配**: 根据用户使用语言决定（中文用户使用中文术语，英文用户使用英文术语）
2. **关键词前置**: 将最重要的技术关键词放在文件名前部
3. **结构清晰**: 主题 + 核心概念 + 技术要点
4. **搜索友好**: 包含工程师常用的技术搜索词

### 具体规则

- **语言**: 适配用户偏好语言，可保留英文技术缩写（如RTOS、PLL、GPIO）
- **长度**: 15-30个字符（不含扩展名）
- **分隔符**: 使用下划线`_`连接各部分
- **禁止**: 无序列号、无日期、**无版本号（禁止_v2、_v3等后缀）**
- **字符**: 允许中文、英文、数字、下划线

### 命名模板

**中文模板:**
```
[技术领域]_[核心概念]_[具体要点].txt
```

**English Template:**
```
[Tech_Domain]_[Core_Concept]_[Specific_Point].txt
```

### 优质文件名示例

**中文示例:**

| 技术主题 | 推荐文件名 |
|---------|-----------|
| FreeRTOS电源管理器优先级 | `FreeRTOS电源管理_电源管理器任务优先级设置.txt` |
| STM32 PLL配置 | `STM32时钟系统_PLL锁相环配置详解.txt` |
| 引用计数实现 | `嵌入式低功耗设计_引用计数电源管理机制.txt` |
| CSS时钟安全 | `STM32时钟安全_CSS失效检测与自动切换.txt` |
| 任务通知机制 | `FreeRTOS任务通信_任务通知实现原理.txt` |

**English Examples:**

| Technical Topic | Recommended Filename |
|----------------|---------------------|
| FreeRTOS Power Manager Priority | `FreeRTOS_Power_Manager_Task_Priority_Configuration.txt` |
| STM32 PLL Configuration | `STM32_Clock_System_PLL_Configuration_Guide.txt` |
| Reference Counting Implementation | `Embedded_Low_Power_Reference_Counting_Mechanism.txt` |
| CSS Clock Security | `STM32_Clock_Security_CSS_Failure_Detection.txt` |
| Task Notification Mechanism | `FreeRTOS_Task_Communication_Task_Notification_Principle.txt` |

### SEO优化要点

- 包含具体技术栈名称（FreeRTOS、STM32、ESP32、Linux、Docker等）
- 使用标准技术术语而非口语化表达
- 包含动作或状态词（配置、实现、机制、原理、详解 / Configuration, Implementation, Mechanism, Guide）
- 避免过于宽泛的词汇（如"教程"、"笔记"、"总结" / tutorial, notes, summary）

### 文件名冲突处理（禁止自动版本号）

**核心原则：禁止自动添加版本号后缀（如_v2、_v3），必须由用户决定最终文件名**

若生成的文件名与现有文件重复：

**场景A: 通过现有笔记检查发现**
- 遵循"现有笔记检查机制"
- 向用户展示冲突并提供选项：
  1. 合并到现有笔记
  2. 另起新文件名（用户提供新标题）
  3. 取消生成

**场景B: 文件名完全相同但内容不同**
1. **禁止自动添加版本号**
2. 向用户报告冲突："文件名 [xxx.txt] 已存在，但内容不同"
3. 要求用户决定：
   - 提供新文件名（建议更具体的标题以区分）
   - 或选择合并到现有文件
   - 或取消生成

**场景C: 文件名和内容均相同**
1. 跳过生成
2. 向用户报告："笔记已存在，跳过重复内容"

### 用户指定新文件名规则

当用户选择"另起新文件名"时：
- 用户提供的新标题必须符合文件名规则（SEO优化、长度限制）
- 系统检查新文件名是否仍冲突，若冲突则再次提示
- 禁止接受带版本号后缀的文件名（如`_v2`）
- 引导用户通过细化主题区分，例如：
  - ❌ 不推荐：`STM32_PLL_v2.txt`
  - ✅ 推荐：`STM32_PLL_高级配置与故障排查.txt`

## 输出规范

- 格式: plain_text
- 扩展名: .txt
- 编码: UTF-8
- 换行符: LF
- 无富文本格式（No Markdown, No HTML, No styling）

## 禁止事项

- 禁止在一篇笔记中解释多个概念
- 禁止使用项目符号（•）、编号列表（1. 2. 3.）或表格
- 禁止出现"综上所述"、"因此"、"所以"等总结性过渡词
- 禁止合并输出
- 禁止在文件头部或尾部添加分隔线、页眉页脚、生成时间戳等元数据

## 质量校验清单

生成文件前必须检查：
- [ ] 字数在250-300字之间
- [ ] 无表情符号
- [ ] 无"此外"、"同时"等连接词引入新主题
- [ ] 无富文本格式标记
- [ ] 无人称代词
- [ ] 文件名为正确格式
- [ ] 已检查现有笔记相似度（如适用）
- [ ] 已获得用户关于合并/新建的确认（如适用）
